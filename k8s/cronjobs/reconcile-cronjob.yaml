apiVersion: batch/v1
kind: CronJob
metadata:
  name: paylink-reconcile
  labels:
    app: paylink
spec:
  # Run hourly; adjust cron as needed
  schedule: "0 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 5
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: paylink
        spec:
          restartPolicy: OnFailure
          containers:
            - name: reconcile
              image: ${RECONCILE_IMAGE:-your-registry/paylink:latest}
              imagePullPolicy: IfNotPresent
              command: ["node", "/app/bin/reconcile.js"]
              env:
                - name: MONGODB_URI
                  valueFrom:
                    secretKeyRef:
                      name: paylink-secrets
                      key: MONGODB_URI
                - name: MONNIFY_BASE_URL
                  valueFrom:
                    secretKeyRef:
                      name: paylink-secrets
                      key: MONNIFY_BASE_URL
                - name: MONNIFY_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: paylink-secrets
                      key: MONNIFY_API_KEY
                - name: MONNIFY_SECRET_KEY
                  valueFrom:
                    secretKeyRef:
                      name: paylink-secrets
                      key: MONNIFY_SECRET_KEY
                - name: PEYFLEX_BASE_URL
                  valueFrom:
                    secretKeyRef:
                      name: paylink-secrets
                      key: PEYFLEX_BASE_URL
                - name: PEYFLEX_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: paylink-secrets
                      key: PEYFLEX_API_KEY
                - name: NODE_ENV
                  value: production
              resources:
                requests:
                  cpu: "200m"
                  memory: "256Mi"
                limits:
                  cpu: "500m"
                  memory: "512Mi"
          # Job-level backoff and deadlines
          activeDeadlineSeconds: 1200 # 20 minutes
          backoffLimit: 2
          # Use imagePullSecrets if your registry requires authentication
          imagePullSecrets:
            - name: regcred
